
[english version](./README_en.md)

# оглавление

- [оглавление](#оглавление)
- [статус выполнения технического задания и комментарии по реализации](#статус-выполнения-технического-задания-и-комментарии-по-реализации)
  - [ТЗ - Создайте простую слот-игру HTML5 с помощью Phaser3/Pixi.js.](#тз---создайте-простую-слот-игру-html5-с-помощью-phaser3pixijs)
  - [тайминги](#тайминги)
  - [немного об архитектуре игры и особенностях ее реализации](#немного-об-архитектуре-игры-и-особенностях-ее-реализации)
  - [немного о том, чего не было в ТЗ](#немного-о-том-чего-не-было-в-тз)
  - [структура папок проекта (очевидное не описываю)](#структура-папок-проекта-очевидное-не-описываю)
  - [немного о недоработках](#немного-о-недоработках)
  - [локальный запуск проекта](#локальный-запуск-проекта)
  - [немного об ассетах](#немного-об-ассетах)
      - [Формат данных анимированного компонента (draft)](#формат-данных-анимированного-компонента-draft)
      - [идея](#идея)
      - [предполагаемые элементы (draft)](#предполагаемые-элементы-draft)
      - [требования](#требования)
      - [демо](#демо)

# статус выполнения технического задания и комментарии по реализации

## ТЗ - Создайте простую слот-игру HTML5 с помощью Phaser3/Pixi.js.

Игра должна включать в себя следующие экраны:
- [x] Экран предварительной загрузки
- [x] Экран загрузки ресурсов с полосой прогресса
- [x] Экран основной игровой сцены
- [x] Фоновое изображение
- [x] Рамка барабанов
- [x] Символы барабанов
- [x] Кнопка вращения
- [x] Анимированный объект Spine

Игровой процесс:
- [x] В слоте 3 барабана и 1 ряд, пример (https://t.ly/fU5eR):
- [x] В слоте 3 разных символа
- [x] После нажатия кнопки вращения барабаны начинают вращаться
- [x] Имитация запроса/ответа от сервера с результатами вращения, рандомизация ответа результата
- [x] Если в результате все 3 символа одинаковы - это выигрыш, воспроизведите звук и анимацию выигрыша
- [x] Включите анимацию Spine в основную игровую сцену, сделайте так, чтобы игровые события, такие как выигрыш/проигрыш, запускали различные состояния анимации Spine (можно использовать любую анимацию Spine, которую вы найдете, например, этого гоблина из примеров Phaser - https://github.com/yandeu/phaser3-spine-example/tree/master)

Другие игровые возможности:
- [x] Воспроизведение фонового звука в цикле
- [x] Добавьте управление для вкл/выкл всех звуков

Требования к проекту:
- [x] Настройте этот игровой проект на GitHub (или другой службе GIT).
- [x] Используйте TypeScript в качестве языка программирования для проекта
- [ ] Используйте Webpack для объединения модулей, ресурсов и обслуживания игры для локальной разработки. **пользовался vite, если всетаки вопрос с вебпакером принципиальный, переделаю на него**
- [x] Включите readme с инструкциями о том, как запустить игру локально
- [x] Используйте npm package.json для зависимостей пакетов и конфигурации
- [x] Включите GSAP для анимации
- [ ] Включите файл Docker для контейнеризации игры (необязательно, только если у вас есть опыт работы с ним)
- [x] Отправьте нам обратно URL-адрес проекта для проверки с любыми комментариями и временем, которое вы потратили на задачу

## тайминги
- весь проект (4.5 рабочих дня - 36 часов)
  - общая архитектура (8 часов)
  - механика вращения барабана, поддерживающая 2 режима (16 часов)
  - остальное (12 часов)

## немного об архитектуре игры и особенностях ее реализации
- стек `vite`, `typescript`, `pixi 8`, `gsup`
- с архитектурой решил немного поэксперементировать, полностью реализовав процесс управления состояниями на `async` `await`. Как мне кажется - эксперемент вышел удачным, логика планировки и запуска асинхронных компонентов а так же управления переключениями их состояний существенно упростилась (субъективное мнение)
- в качестве основного системного таймера (тикера) взял таймер от `gsap`. На него завязал все, от управления анимациями, до управления внутренними таймингами компонентов игры. Сделал так для того, чтобы была единая точка управления таймингами.
- использовал личную разработку - ассеты (зип архивы с медиаданными и `json` данными, описывающими структуры слоев, их наполнение спрайтами, а так же наборами анимаций), плагин для пикси реализующий загрузку этих ассетов, компонет реализующий отображение этих ассетов и их анимаций

## немного о том, чего не было в ТЗ
- добавлены механики адаптивной подстройки размера игры под экран при ресайзах
- добавлены механики постановки игры на паузу при неактивности вкладки с игрой
- добавлена кнопка перехода в полноэкранный режим и выхода из него

## структура папок проекта (очевидное не описываю)
- `./public` - папка со статикой (загружаемые ресурсы игры) в сумме заняло около (6 часов)
- `./public/style.css`
- `./public/assets`
- `./public/assets/pack.sh` - скрипт упаковки данных в ассеты
- `./public/assets/preloader` - папка с исходными данными для ассета `preloader.asset`
- `./public/assets/logo` - папка с исходными данными для ассета `logo.asset`
- `./public/assets/top_buttons` - папка с исходными данными для ассета `top_buttons.asset`
- `./public/assets/logo.asset` - загружаемый ассет начальной заставки (спрайты, слои, анимации)
- `./public/assets/preloader.asset` - загружаемый ассет прелоадера (спрайты, звуки, слои, анимации)
- `./public/assets/top_buttons.asset` - загружаемый ассет системных кнопок (спрайты, слои)
- `./public/assets/progress` - загружаемые ресурсы прогрессбара
- `./public/assets/slot` -
- `./public/assets/slot/pack.sh` - скрипт упаковки данных в ассеты
- `./public/assets/slot/reels` - папка с исходными данными для ассета рамки барабанов `reels.asset`
- `./public/assets/slot/reel` - папка с исходными данными для ассета символов `reel.asset`
- `./public/assets/slot/slot` - папка с исходными данными для ассета интерфейса иргы `slot.asset`
- `./public/assets/slot/reel.asset` - загружаемый ассет с символами (спрайты, звуки)
- `./public/assets/slot/reels.asset` - загружаемый ассет с рамкой барабанов (спрайты, слои)
- `./public/assets/slot/slot.asset` - загружаемый ассет с остальной графикой слота (спрайты, звуки, слои, анимации)
- `./src` 
- `./src/core` - общее ядро игры (не слота, а любой)
- `./src/core/utils` 
- `./src/core/utils/deepClone.ts` 
- `./src/core/utils/unzip.ts` - утилита для распаковки `zip` архива
- `./src/core/utils/parsePath.ts` - утилита для паринга структуры папок загружаемых архивов с ассетами
- `./src/core/utils/sleep.ts` - простенький набор асинхронных утилит, работающих на таймере от `gsap`
- `./src/core/components` 
- `./src/core/components/Component.ts` - непосредственно компонент, реализующий отображение ассетов (создание структуры слоев, текстур спрайтов, звуков, запуска анимаций)
- `./src/core/components/ComponentResources.ts` - класс хранящий ресурсы загруженного ассета
- `./src/core/components/TweenDeferred.ts`  - вспомогательный класс для хранения и управления анимациями ассетазагруженного ассета
- `./src/core/parsers` - плагин для загрузчика пикси расширяющий его для загрузки ассетов 
- `./src/core/parsers/gsapTypes.ts` -
- `./src/core/parsers/loadAssetTypes.ts` -
- `./src/core/parsers/loadAssets.ts` -
- `./src/core/commons` -
- `./src/core/commons/BaseController.ts` - базовый класс задающий обязательные методы всех контроллеров в архитектуре игры
- `./src/core/BaseGame.ts` - базовый класс реализующий инициализацию `pixi` и `gsap`, встраивающий пикси приложение на страницу, реадизующий механики ресайза игры, постановку игры на паузу при покидании вкладки и другое подобное
- `./src/core/sounds` -
- `./src/core/sounds/Sounds.ts`  - статичный класс реализующий централизованную работу со звуками
- `./src/index.ts` - точка входа
- `./src/game` -
- `./src/game/components` -
- `./src/game/components/preloader` -
- `./src/game/components/preloader/Preloader.ts` - контроллер прелоадера, в качестве вью - Component с ассетом preloader.asset
- `./src/game/components/logo` -
- `./src/game/components/logo/Logo.ts` - контроллер начальной заставки, в качестве вью - Component с ассетом logo.asset
- `./src/game/components/progress_bar` -
- `./src/game/components/progress_bar/ProgressBar.ts` - компонент прогрессбара (поленился, тут и контроллер и вью в одном корпусе)
- `./src/game/components/slot` -
- `./src/game/components/slot/BaseSlotReel.ts`  - базовый компонент с барабаном, реадизует визуализацию вращения барабанов в 2-х режимах: 1. бесконечное вращение в ожидании ответа сервера. 2. завершение вращение и выпадение символов, присланных сервером. На это компонент потратил лвиную долю времени (16 часов)
- `./src/game/components/slot/BaseSlotReels.ts` - базовый компонент с барабанами, реализует логику инициализации отдельных барабанов и управления ими
- `./src/game/components/slot/BaseSlotGame.ts`  - базовый компонент слот игры, реализует логику инициализации барабана и интерфеса и управления ими
- `./src/game/components/slot/SlotReel.ts` - компонент с реализацией отдельного барабана данного слота
- `./src/game/components/slot/SlotReels.ts` - компонент с реализацией барабанов данного слота
- `./src/game/components/slot/SlotGame.ts` - компонент с реализацией данного слота
- `./src/game/components/spine` -
- `./src/game/components/spine/SpineBoy.ts` - контроллер для спайн персонажа
- `./src/game/Game.ts` - наследуется от BaseGame, реализует процесс запуска данного слота
- `./src/game/network` -
- `./src/game/network/MockServer.ts` - имитация сервера
- `./src/game/network/GameProxy.ts` - прокси для взаимодействия игры с имитацией сервера
- `./src/game/common` -
- `./src/game/common/SystemButtons.ts` - компонент с реализацией системных кнопок (фулскрин и включение/выключение звука)
- `./index.html` -

## немного о недоработках
- для компонентов `BaseSlotReel`, `BaseSlotReels`, `BaseSlotGame` и их наследников `SlotReel`, `SlotReels`, `SlotGame` можно провести разделение на контроллер и вью, но пока это не успел сделать, не хотел затягивать со сроками сдачи ТЗ. 
- текущая реализация использует не `webpack` а `vite`. последние несколько лет работал с `vite`, и то только в личных домашних проектах а `webpack` существенно подзабыл. если вопрос принципиальный - перенастрою.

<hr>

## локальный запуск проекта

клонируем репозиторий на локальную машину
`git clone https://github.com/lastuniverse/test-task-selesa.git`

переходим в папку склонированного репозитория
`cd test-task-selesa`

устанавливаем зависимости
`npm install`

запускаем
`npm run dev`

после чего автоматически запустится дев сервер и в браузере откроется страничка с игрой с адресом http://localhost:8081/

<hr>

## немного об ассетах

#### Формат данных анимированного компонента (draft) 
> draft - по сути это лишь идея/макет, который может и должен быть вдумчиво доработан

#### идея
сделать формат данных упрощающий разработку и использование самостоятельных компонентов UI, их представлений и наборов их анимаций.

#### предполагаемые элементы (draft) 
- медиа данные (общие для всех представлений)
	- изображения спрайтов
	- json-атласы и изображения спрайтлистов
	- звуки/музыка (в двух вариантах, упакованные в ассет компонента и подгружаемые по ссылке)
	- видео (не пакуются в ассет, а делаются подгружаемыми по ссылке)
	- другие анимированные компоненты (не пакуются в ассет, а делаются подгружаемыми по ссылке)
- данные
  - спрайты: json-данные связывающие названия изображений и других медиаданных с именованным набором параметров. Далее эти данные используются для наполнения слоев
  - слои: json-данные со структурой и взаимным расположением слоев, спрайтов (включая и фреймы из спрайтлистов) и подгружаемых элементов (таких, как видео и другие компоненты)
  - группы: именованные списки имен спрайтов и слоев. Используются для удобства применения наборов фильтров/анимаций сразу к группе (на примере из демо нам нужно например разнести облака по двум слоям, один за горой, другой перед, но к обоим слоям надо применить фильтр размытия и прозрачность, чтобы не прописывать это вручную для каждого слоя объединяем их в группу и применяем фильтры к группе. В настоящий момент в демо не реализовано)
  - анимации: именованные наборы параметров gsap анимаций, и объектов (слоев, групп, спрайтов, внешних компонентов и видео) к которым они применяются
  - представления - именованные папки, каждая со своим набором json-в спрайтов, слоев, групп, анимаций (в демо не реализовано)
  - пока не понятно к чему отнести их активацию, к представлениям, или к анимациям (собрать информацию о предполагаемом использовании компонент и принять решение)


#### требования
- единый загружаемый файл с медиаданными, вариантами их компоновки для различных представлений и их наборами анимаций
- реализовать возможность задавать несколько представлений и переключаться между ними
- реализовать возможность для каждого представления задавать свою собственную структуру компоновки слоев, спрайтов, групп и т.д.
- реализовать возможность для каждого представления запускать свои анимации и/или наборы анимаций посредством gsap а так же управлять их проигрыванием (по аналогии со spine компонентами).


#### демо

[смотреть демо](https://game.ragame.ru/ohae/)
[файл-ассет с компонентом демосцены](https://game.ragame.ru/ohae/assets/logo/logo.asset) (зип архив)

в текущей реализации демо:
- `meta.json` - данные о версии и типе ассета
- `images` - папка со спрайтами (в дальнейшем и со спрайтлистами)
- `sounds` - папка со звуками
- `data` - папка с json-данными спрайтов, слоев, анимаций
   - `layers.json` - данные спрайтов
   - `sprites.json` - данные слоев
   - `intro.gsap.json` - данные с наборами параметров gsap анимаций, и объектам их применения (уже текущая реализация позволяет иметь несколько наборов анимаций)


текущая программная реализация: 
- класс компонента, наследуемый от `PIXI.Container`
- дополнительный `PIXI.Loader`, загружающий данный файл ассета, распаковывающий его, и формирующий набор данных для инициализации класс компонента